# su.md

- This file is a complete, practical deep dive into **/etc/pam.d/su** — the PAM configuration that controls the `su` command. `su` is one of the most sensitive authentication entry points on a Linux system because it allows switching identities, including becoming root. Mistakes in this file can break privilege escalation, allow unauthorized elevation, or completely lock out non-root users.

This document covers:
- how `su` authentication works
- how PAM phases behave differently from SSH
- what each module does in the `su` stack
- how AD users are handled when using `su`
- how to test `su` authentication safely
- common failure scenarios and exact fixes

---

- [su.md](#sumd)
- [What `su` actually does](#what-su-actually-does)
- [Typical PAM file for `su`](#typical-pam-file-for-su)
- [Line-by-line explanation](#line-by-line-explanation)
  - [`auth sufficient pam_rootok.so`](#auth-sufficient-pam_rootokso)
  - [`auth required pam_wheel.so use_uid`](#auth-required-pam_wheelso-use_uid)
  - [`auth include system-auth`](#auth-include-system-auth)
  - [`account sufficient pam_succeed_if.so uid = 0 use_uid`](#account-sufficient-pam_succeed_ifso-uid--0-use_uid)
  - [`password include system-auth`](#password-include-system-auth)
  - [`session include system-auth`](#session-include-system-auth)
- [How AD users behave when using `su`](#how-ad-users-behave-when-using-su)
- [Practical tests for `su` authentication](#practical-tests-for-su-authentication)
  - [Test local user authentication:](#test-local-user-authentication)
  - [Test AD authentication via su:](#test-ad-authentication-via-su)
  - [Test `su -` to root:](#test-su---to-root)
- [Real-world failure scenarios and fixes](#real-world-failure-scenarios-and-fixes)
  - [1. AD users can SSH but cannot `su -`](#1-ad-users-can-ssh-but-cannot-su--)
  - [2. AD users cannot `su` to other AD users](#2-ad-users-cannot-su-to-other-ad-users)
  - [3. `su - user` asks for password twice or fails unexpectedly](#3-su---user-asks-for-password-twice-or-fails-unexpectedly)
  - [4. su gives `Authentication failure` but SSH works](#4-su-gives-authentication-failure-but-ssh-works)
  - [5. root cannot `su` into an AD user](#5-root-cannot-su-into-an-ad-user)
- [Debugging su](#debugging-su)
- [Checklist after modifying su configuration](#checklist-after-modifying-su-configuration)
- [What you achieve after this file](#what-you-achieve-after-this-file)


<br>
<br>

# What `su` actually does

The `su` binary swaps your current identity to another account. Typical usage:
```bash
su - username
```

If no username is provided, it defaults to `root`:
```bash
su -
```

Unlike SSH, `su` **never prompts for the target user's password unless the caller is non-root**. Root can `su` to any user without entering any password because root bypasses authentication.

Because of that, the PAM logic for `su` is different from SSH and login.

`su` does **not** use password-auth — it uses **only its own PAM file**:
```bash
/etc/pam.d/su
```

It may include `system-auth` but does not include `password-auth`.

---

<br>
<br>

# Typical PAM file for `su`

A standard Rocky/RHEL su configuration looks like this:

```bash
#%PAM-1.0
auth        sufficient    pam_rootok.so
auth        required      pam_wheel.so use_uid
auth        include       system-auth
account     sufficient    pam_succeed_if.so uid = 0 use_uid
auth        include       system-auth
password    include       system-auth
session     include       system-auth
```

I will break down each line.

---

<br>
<br>

# Line-by-line explanation

## `auth sufficient pam_rootok.so`

This module grants instant authentication if the **calling user is root**. That means:
- if root runs `su - username`, PAM instantly succeeds
- no password is required

If you remove or disable this module, even root will be forced to authenticate, which is not recommended.

---

<br>
<br>

## `auth required pam_wheel.so use_uid`

This module restricts who can `su` to root.

It checks whether the **calling user** is in the `wheel` group.

Example behavior:
- user `alice` in wheel → allowed to attempt `su -`
- user `bob` not in wheel → denied before even checking a password

If you want only specific AD groups to `su` root, you must add that AD group to the local `wheel` group:
```bash
usermod -aG wheel '%domain admins@gohel.local'
```

Or use sssd group mappings.

---

<br>
<br>

## `auth include system-auth`

The moment execution reaches this line, the entire **system-auth** stack is executed.

This is where:
- pam_unix.so authenticates local users
- pam_sss.so reaches SSSD
- pam_faillock.so handles lockouts

This means **su becomes AD-aware** only because system-auth contains pam_sss.so.

If AD users cannot `su`, check:
1. system-auth includes pam_sss.so in the auth phase
2. SSSD is online and working
3. su is allowed by your AD access control policies

---

<br>
<br>

## `account sufficient pam_succeed_if.so uid = 0 use_uid`

This rule allows root to bypass account checks.
```bash
if (uid_of_target == 0) allow
```

It prevents accidental blocks when logging in as root.

---

<br>
<br>

## `password include system-auth`
Delegates password change operations to system-auth.

Only used if you run:
```bash
passwd
```
inside a session initiated by su.

---

<br>
<br>

## `session include system-auth`
After authentication succeeds, the session phase initializes environment, limits, home dir creation (for AD users), etc.

---

<br>
<br>

# How AD users behave when using `su`

Important behavior:
- AD users **can su** into other AD accounts only if pam_sss.so is correctly configured in system-auth
- AD users **cannot su to root** unless:
  - they are in the local wheel group
  - or pam_wheel.so config is modified to allow them

Check wheel group membership:
```bash
getent group wheel
```

If AD groups do not appear in wheel membership, fix group mapping or add explicit members.

---

<br>
<br>

# Practical tests for `su` authentication

## Test local user authentication:
```bash
su - localuser
```

If it fails:
- pam_unix.so misordered in system-auth
- user/shadow entry is invalid

---

<br>
<br>

## Test AD authentication via su:
```bash
su - testuser1
```

If `id testuser1` works but `su - testuser1` fails:
- system-auth missing pam_sss.so
- Kerberos working but account phase failing
- AD denies privilege to log in locally

Check logs:
```bash
tail -f /var/log/sssd/sssd_pam.log
```

---

<br>
<br>

## Test `su -` to root:
```bash
su -
```

If not in wheel group, you will see:
```bash
su: Permission denied
```

Check wheel membership:
```bash
id username
```

Add user/group to wheel:
```bash
usermod -aG wheel username
```

For AD:
```bash
gpasswd -a 'DOMAIN\\groupname' wheel
```

---

<br>
<br>

# Real-world failure scenarios and fixes

## 1. AD users can SSH but cannot `su -`
Cause:
- pam_wheel.so blocking

Fix:
```bash
gpasswd -a 'DOMAIN\\AD_Group' wheel
```

Verify:
```bash
getent group wheel
```

---

<br>
<br>

## 2. AD users cannot `su` to other AD users
Cause:
- system-auth missing pam_sss.so

Fix:
Ensure system-auth has:
```bash
auth sufficient pam_sss.so use_first_pass
```

---

<br>
<br>

## 3. `su - user` asks for password twice or fails unexpectedly
Cause:
- wrong order of pam_unix.so and pam_sss.so
- try_first_pass / use_first_pass mismatch

Fix:
Use consistent flags:
```bash
auth sufficient pam_unix.so try_first_pass
auth sufficient pam_sss.so use_first_pass
```

---

<br>
<br>

## 4. su gives `Authentication failure` but SSH works
Cause:
- password-auth.ok → SSH works
- system-auth broken → su fails

Fix:
Compare both configs:
```bash
diff /etc/pam.d/system-auth /etc/pam.d/password-auth
```

Ensure system-auth contains SSSD and faillock lines.

---

<br>
<br>

## 5. root cannot `su` into an AD user
Cause:
- SSSD offline
- AD user identity unavailable

Fix:
```bash
systemctl restart sssd
sssctl domain-status
```

---

<br>
<br>

# Debugging su

Logs for su land in:
```bash
/var/log/secure
```

Search for relevant lines:
```bash
grep su: /var/log/secure
```

For SSSD troubleshooting during su attempt:
```bash
tail -f /var/log/sssd/sssd_pam.log
```

---

<br>
<br>

# Checklist after modifying su configuration

- Does root `su -` without being blocked?  
- Do local users succeed?  
- Do AD users succeed?  
- Does `id username` show relevant group memberships?  
- Does wheel group contain correct members?  
- Is system-auth consistent with password-auth?  
- Do faillock counters allow login?

---

<br>
<br>

# What you achieve after this file

You now fully understand:
- how su authentication flows through PAM
- how pam_rootok and pam_wheel enforce privilege control
- how AD authentication works inside su
- how to debug su failures with logs and commands
- how to tune or lock down su access securely

This makes you capable of handling privilege escalation behavior in enterprise Linux systems with confidence — especially in AD-integrated environments.